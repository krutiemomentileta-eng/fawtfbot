<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>‚≠ê Tap & Win!</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background: radial-gradient(
          ellipse at 50% 40%,
          #fff 0%,
          #f8f9fa 50%,
          #f0f1f3 100%
        );
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }

      .hidden {
        display: none !important;
      }

      #vfx-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      #flash {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 999;
        pointer-events: none;
        opacity: 0;
      }

      /* ===== MAIN SCENE ===== */
      #main-scene {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2;
      }

      #star-area {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 260px;
        height: 260px;
      }

      #rays-container {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
      }

      .ray {
        position: absolute;
        top: 48%;
        left: 50%;
        width: 3px;
        height: 130px;
        transform-origin: bottom center;
        transform: translate(-50%, -100%) rotate(calc(var(--i) * 30deg));
        background: linear-gradient(
          to top,
          rgba(255, 215, 0, 0.5),
          rgba(255, 215, 0, 0)
        );
        border-radius: 2px;
        animation: ray-pulse 2s ease-in-out infinite;
        animation-delay: calc(var(--i) * 0.12s);
      }

      @keyframes ray-pulse {
        0%,
        100% {
          opacity: 0.2;
          height: 100px;
        }
        50% {
          opacity: 0.7;
          height: 160px;
        }
      }

      #glow {
        position: absolute;
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 215, 0, 0.25) 0%,
          transparent 70%
        );
        filter: blur(15px);
        animation: glow-breathe 3s ease-in-out infinite;
        pointer-events: none;
      }

      @keyframes glow-breathe {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.6;
        }
        50% {
          transform: scale(1.3);
          opacity: 1;
        }
      }

      #star-wrapper {
        position: relative;
        cursor: pointer;
        z-index: 10;
        width: 140px;
        height: 140px;
      }

      #star-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 90px;
        animation: star-float 3s ease-in-out infinite;
        filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.4));
      }

      @keyframes star-float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }

      #pulse-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 150px;
        height: 150px;
        border: 2px solid rgba(255, 215, 0, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: pulse-expand 2s ease-out infinite;
        pointer-events: none;
      }

      @keyframes pulse-expand {
        0% {
          transform: translate(-50%, -50%) scale(0.8);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -50%) scale(2.2);
          opacity: 0;
        }
      }

      #tap-text {
        margin-top: 20px;
        font-size: 26px;
        font-weight: 800;
        color: #333;
        letter-spacing: 2px;
      }

      .bounce-letter {
        display: inline-block;
        animation: letter-bounce 1.5s ease-in-out infinite;
        animation-delay: calc(var(--d) * 0.08s);
      }

      @keyframes letter-bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        25% {
          transform: translateY(-6px);
        }
      }

      #tap-counter {
        margin-top: 16px;
        text-align: center;
      }

      #progress-bar {
        width: 180px;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
        margin: 0 auto 6px;
      }

      #progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #ffd700, #ffa500);
        border-radius: 3px;
        transition: none;
      }

      #counter-text {
        font-size: 13px;
        color: #aaa;
        font-weight: 600;
      }

      .tap-effect {
        position: fixed;
        font-size: 22px;
        font-weight: 900;
        color: #ffd700;
        pointer-events: none;
        z-index: 100;
        text-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
        animation: tap-fly 0.7s ease-out forwards;
      }

      @keyframes tap-fly {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-70px) scale(1.4);
        }
      }

      /* ===== ROULETTE ===== */
      #roulette-scene {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 60;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: radial-gradient(ellipse at center, #fff 0%, #f5f5f5 100%);
      }

      #roulette-title {
        font-size: 22px;
        font-weight: 700;
        color: #333;
        margin-bottom: 30px;
      }

      #roulette-wrapper {
        position: relative;
        width: 92%;
        max-width: 450px;
      }

      #roulette-viewport {
        width: 100%;
        height: 120px;
        overflow: hidden;
        border-radius: 16px;
        background: #fafafa;
        border: 1px solid #eee;
        position: relative;
      }

      #roulette-strip {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .roulette-item {
        position: absolute;
        top: 10px;
        width: 96px;
        height: 96px;
        border: 2.5px solid #d0d0d0;
        border-radius: 14px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .roulette-sticker {
        width: 72px;
        height: 72px;
      }
      .roulette-emoji {
        font-size: 42px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 72px;
        height: 72px;
      }

      #roulette-pointer-top {
        position: absolute;
        top: -14px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 11px solid transparent;
        border-right: 11px solid transparent;
        border-top: 14px solid #ffd700;
        z-index: 10;
        filter: drop-shadow(0 2px 4px rgba(255, 215, 0, 0.5));
      }

      #roulette-pointer-bottom {
        position: absolute;
        bottom: -14px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 11px solid transparent;
        border-right: 11px solid transparent;
        border-bottom: 14px solid #ffd700;
        z-index: 10;
      }

      #roulette-line {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 50%;
        width: 2.5px;
        background: rgba(255, 215, 0, 0.6);
        transform: translateX(-50%);
        z-index: 10;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
        pointer-events: none;
      }

      /* ===== PRIZE RESULT MODAL ===== */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }

      .modal-box {
        background: white;
        border-radius: 24px;
        padding: 30px 24px;
        text-align: center;
        max-width: 340px;
        width: 90%;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-box h2 {
        font-size: 20px;
        color: #888;
        margin-bottom: 14px;
        font-weight: 600;
        letter-spacing: 1px;
      }

      .modal-sticker {
        width: 120px;
        height: 120px;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 65px;
      }

      .modal-prize-name {
        font-size: 20px;
        font-weight: 800;
        color: #333;
        margin-bottom: 20px;
      }

      .btn-primary {
        position: relative;
        width: 100%;
        padding: 15px;
        font-size: 16px;
        font-weight: 700;
        color: white;
        background: linear-gradient(135deg, #ffd700, #ffa500, #ff6b6b);
        background-size: 200% 200%;
        border: none;
        border-radius: 14px;
        cursor: pointer;
        overflow: hidden;
        animation: gradient-shift 3s ease infinite;
        box-shadow: 0 4px 15px rgba(255, 165, 0, 0.4);
      }

      .btn-primary:active {
        transform: scale(0.95);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        pointer-events: none;
      }

      @keyframes gradient-shift {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      .btn-shine {
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.35),
          transparent
        );
        animation: shine-move 2s ease-in-out infinite;
      }

      @keyframes shine-move {
        0% {
          left: -100%;
        }
        50%,
        100% {
          left: 100%;
        }
      }

      /* ===== SUBSCRIBE MODAL ===== */
      .subscribe-desc {
        font-size: 14px;
        color: #666;
        margin-bottom: 18px;
        line-height: 1.5;
      }

      .channel-list {
        list-style: none;
        margin-bottom: 20px;
      }

      .channel-item {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .channel-item:last-child {
        border-bottom: none;
      }

      .channel-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: #e0e0e0;
        margin-right: 12px;
        flex-shrink: 0;
        object-fit: cover;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #999;
      }

      .channel-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }

      .channel-info {
        flex: 1;
        text-align: left;
        min-width: 0;
      }

      .channel-name {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .channel-sub-btn {
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 600;
        color: #fff;
        background: #3390ec;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        flex-shrink: 0;
        margin-left: 10px;
        text-decoration: none;
        display: inline-block;
      }

      .channel-sub-btn.done {
        background: #4caf50;
        pointer-events: none;
      }

      .channel-sub-btn:active {
        opacity: 0.8;
      }

      /* Toast notification */
      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: #ff4757;
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        transition: transform 0.3s ease;
        pointer-events: none;
      }

      .toast.show {
        transform: translateX(-50%) translateY(0);
      }

      .toast.success {
        background: #4caf50;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
      }

      /* ===== FINAL SCREEN ===== */
      .final-icon {
        font-size: 50px;
        margin-bottom: 15px;
      }

      .final-title {
        font-size: 18px;
        font-weight: 700;
        color: #333;
        margin-bottom: 10px;
      }

      .final-text {
        font-size: 14px;
        color: #888;
        line-height: 1.5;
      }

      /* Loading */
      .loading-spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #eee;
        border-top: 3px solid #ffd700;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <canvas id="vfx-canvas"></canvas>
    <div id="flash"></div>
    <div id="toast" class="toast"></div>

    <!-- SCENE 1: TAP -->
    <div id="main-scene">
      <div id="star-area">
        <div id="rays-container"></div>
        <div id="glow"></div>
        <div id="star-wrapper">
          <div id="star-container"></div>
          <div id="pulse-ring"></div>
        </div>
      </div>
      <div id="tap-text">
        <span class="bounce-letter" style="--d: 0">–ñ</span
        ><!--
        --><span class="bounce-letter" style="--d: 1">–º</span
        ><!--
        --><span class="bounce-letter" style="--d: 2">–∏</span
        ><!--
        --><span class="bounce-letter" style="--d: 3">&nbsp;</span
        ><!--
        --><span class="bounce-letter" style="--d: 4">–∂</span
        ><!--
        --><span class="bounce-letter" style="--d: 5">–º</span
        ><!--
        --><span class="bounce-letter" style="--d: 6">–∏</span
        ><!--
        --><span class="bounce-letter" style="--d: 7">!</span>
      </div>
      <div id="tap-counter">
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <span id="counter-text">0 / 10</span>
      </div>
    </div>

    <!-- SCENE 2: ROULETTE -->
    <div id="roulette-scene" class="hidden">
      <div id="roulette-title">üé∞ –ö—Ä—É—Ç–∏–º —Ä—É–ª–µ—Ç–∫—É...</div>
      <div id="roulette-wrapper">
        <div id="roulette-pointer-top"></div>
        <div id="roulette-pointer-bottom"></div>
        <div id="roulette-line"></div>
        <div id="roulette-viewport">
          <div id="roulette-strip"></div>
        </div>
      </div>
    </div>

    <!-- MODAL: Prize result -->
    <div id="modal-prize" class="modal-overlay hidden">
      <div class="modal-box">
        <h2>–í–ê–ú –í–´–ü–ê–õ:</h2>
        <div id="modal-prize-sticker" class="modal-sticker"></div>
        <p id="modal-prize-name" class="modal-prize-name"></p>
        <button id="btn-claim" class="btn-primary">
          <span>–ó–ê–ë–†–ê–¢–¨</span>
          <span class="btn-shine"></span>
        </button>
      </div>
    </div>

    <!-- MODAL: Subscribe -->
    <div id="modal-subscribe" class="modal-overlay hidden">
      <div class="modal-box">
        <h2>üéÅ –ü–æ–ª—É—á–∏—Ç–µ –ø—Ä–∏–∑!</h2>
        <div id="sub-sticker" class="modal-sticker"></div>
        <p id="sub-prize-name" class="modal-prize-name"></p>
        <p class="subscribe-desc">
          –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–∑, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞&nbsp;–Ω–∞—à–∏—Ö —Å–ø–æ–Ω—Å–æ—Ä–æ–≤:
        </p>
        <ul id="channel-list" class="channel-list"></ul>
        <button id="btn-check-sub" class="btn-primary">
          <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</span>
          <span class="btn-shine"></span>
        </button>
      </div>
    </div>

    <!-- MODAL: Final (claimed) -->
    <div id="modal-final" class="modal-overlay hidden">
      <div class="modal-box">
        <div class="final-icon">‚úÖ</div>
        <div id="final-sticker" class="modal-sticker"></div>
        <p id="final-prize-name" class="modal-prize-name"></p>
        <h3 class="final-title">–ó–ê–Ø–í–ö–ê –ù–ê –í–´–í–û–î –ü–†–ò–ó–ê –û–¢–ü–†–ê–í–õ–ï–ù–ê!</h3>
        <p class="final-text">
          –ü—Ä–∏–∑ –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.<br />–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ! üéâ
        </p>
      </div>
    </div>

    <script>
      // ==============================================================
      //  CONFIG
      // ==============================================================
      const API_BASE = "/api";
      const MAIN_STICKER_TGS = "assets/gift.tgs";
      const MAIN_STICKER_EMOJI = "üéÅ";
      const MAX_TAPS = 10;
      const ROULETTE_TOTAL = 80;
      const ITEM_W = 96;
      const ITEM_GAP = 10;
      const ITEM_STEP = ITEM_W + ITEM_GAP;

      let PRIZES = [];
      let CHANNELS = [];
      let USER_STATE = null; // { state, prize_key, prize_name, ... }

      // ==============================================================
      //  TGS
      // ==============================================================
      const tgsCache = {};
      async function loadTGS(url) {
        if (tgsCache[url] !== undefined) return tgsCache[url];
        try {
          const r = await fetch(url);
          if (!r.ok) throw new Error(r.status);
          const buf = await r.arrayBuffer();
          tgsCache[url] = JSON.parse(
            pako.inflate(new Uint8Array(buf), { to: "string" }),
          );
          return tgsCache[url];
        } catch (e) {
          tgsCache[url] = null;
          return null;
        }
      }

      let activeLotties = [];
      function playLottieIn(container, tgsUrl, emoji) {
        container.innerHTML = "";
        const data = tgsCache[tgsUrl];
        if (data) {
          try {
            const anim = lottie.loadAnimation({
              container,
              renderer: "svg",
              loop: true,
              autoplay: true,
              animationData: JSON.parse(JSON.stringify(data)),
            });
            activeLotties.push(anim);
            return anim;
          } catch (e) {}
        }
        container.textContent = emoji || "üéÅ";
        return null;
      }

      function destroyAllLotties() {
        activeLotties.forEach((a) => {
          try {
            a.destroy();
          } catch (e) {}
        });
        activeLotties = [];
      }

      // ==============================================================
      //  API
      // ==============================================================
      function getInitData() {
        try {
          return Telegram.WebApp.initData;
        } catch (e) {
          return "";
        }
      }

      async function apiCall(endpoint, body = {}) {
        const res = await fetch(`${API_BASE}/${endpoint}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ initData: getInitData(), ...body }),
        });
        return res.json();
      }

      // ==============================================================
      //  TOAST
      // ==============================================================
      function showToast(text, type = "error", ms = 3000) {
        const t = document.getElementById("toast");
        t.textContent = text;
        t.className = "toast " + type;
        requestAnimationFrame(() => t.classList.add("show"));
        setTimeout(() => t.classList.remove("show"), ms);
      }

      // ==============================================================
      //  PARTICLES
      // ==============================================================
      class Particles {
        constructor(c) {
          this.c = c;
          this.ctx = c.getContext("2d");
          this.p = [];
          this.on = true;
          this.resize();
          window.addEventListener("resize", () => this.resize());
        }
        resize() {
          const d = devicePixelRatio;
          this.c.width = innerWidth * d;
          this.c.height = innerHeight * d;
          this.c.style.width = innerWidth + "px";
          this.c.style.height = innerHeight + "px";
          this.ctx.setTransform(d, 0, 0, d, 0, 0);
        }
        stop() {
          this.on = false;
        }
        resume() {
          if (!this.on) {
            this.on = true;
            this.tick();
          }
        }
        ambient(n = 12) {
          for (let i = 0; i < n; i++)
            this.p.push({
              t: "a",
              x: Math.random() * innerWidth,
              y: Math.random() * innerHeight,
              r: 1 + Math.random() * 2,
              sx: (Math.random() - 0.5) * 0.2,
              sy: (Math.random() - 0.5) * 0.2,
              ph: Math.random() * 6.28,
              op: 0.03 + Math.random() * 0.08,
            });
        }
        burst(px, py, n = 8) {
          for (let i = 0; i < n; i++) {
            const a = (6.28 / n) * i,
              s = 2 + Math.random() * 3;
            this.p.push({
              t: "b",
              x: px,
              y: py,
              vx: Math.cos(a) * s,
              vy: Math.sin(a) * s,
              r: 1.5 + Math.random() * 2.5,
              life: 1,
              dec: 0.03 + Math.random() * 0.02,
              col: ["#FFD700", "#FFA500", "#FF6B6B", "#fff"][
                ~~(Math.random() * 4)
              ],
              g: 0.08,
            });
          }
        }
        explode(px, py, n = 60) {
          for (let i = 0; i < n; i++) {
            const a = Math.random() * 6.28,
              s = 3 + Math.random() * 8;
            this.p.push({
              t: "b",
              x: px,
              y: py,
              vx: Math.cos(a) * s,
              vy: Math.sin(a) * s,
              r: 1.5 + Math.random() * 3,
              life: 1,
              dec: 0.008 + Math.random() * 0.01,
              col: [
                "#FFD700",
                "#FFA500",
                "#FF6B6B",
                "#FF69B4",
                "#00CED1",
                "#7B68EE",
              ][~~(Math.random() * 6)],
              g: 0.1,
              fr: 0.98,
            });
          }
        }
        tick() {
          if (!this.on) return;
          const c = this.ctx;
          c.clearRect(0, 0, innerWidth, innerHeight);
          for (let i = this.p.length - 1; i >= 0; i--) {
            const p = this.p[i];
            if (p.t === "a") {
              p.x += p.sx;
              p.y += p.sy;
              p.ph += 0.015;
              c.fillStyle = `rgba(255,215,0,${p.op * (0.5 + 0.5 * Math.sin(p.ph))})`;
              c.beginPath();
              c.arc(p.x, p.y, p.r, 0, 6.28);
              c.fill();
              if (p.x < -10) p.x = innerWidth + 10;
              if (p.x > innerWidth + 10) p.x = -10;
              if (p.y < -10) p.y = innerHeight + 10;
              if (p.y > innerHeight + 10) p.y = -10;
            } else {
              p.x += p.vx;
              p.y += p.vy;
              p.vy += p.g;
              if (p.fr) {
                p.vx *= p.fr;
                p.vy *= p.fr;
              }
              p.life -= p.dec;
              if (p.life <= 0) {
                this.p.splice(i, 1);
                continue;
              }
              c.globalAlpha = p.life;
              c.fillStyle = p.col;
              c.beginPath();
              c.arc(p.x, p.y, p.r * p.life, 0, 6.28);
              c.fill();
              c.globalAlpha = 1;
            }
          }
          requestAnimationFrame(() => this.tick());
        }
      }

      // ==============================================================
      //  SHAKE
      // ==============================================================
      let shakeAmt = 0,
        shakeFrozen = false,
        shakeRaf = null;
      const shakeEl = document.getElementById("main-scene");
      function addShake(a) {
        shakeAmt = Math.min(shakeAmt + a, 50);
        if (!shakeRaf) runShake();
      }
      function freezeShake(a, ms) {
        shakeAmt = a;
        shakeFrozen = true;
        if (!shakeRaf) runShake();
        setTimeout(() => {
          shakeFrozen = false;
        }, ms);
      }
      function runShake() {
        if (shakeAmt < 0.3 && !shakeFrozen) {
          shakeEl.style.transform = "";
          shakeRaf = null;
          return;
        }
        shakeEl.style.transform = `translate(${(Math.random() - 0.5) * shakeAmt * 2}px,${(Math.random() - 0.5) * shakeAmt * 2}px)`;
        if (!shakeFrozen) shakeAmt *= 0.88;
        shakeRaf = requestAnimationFrame(runShake);
      }

      // ==============================================================
      //  ROULETTE (–≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
      // ==============================================================
      let winnerPrize = null,
        winnerIndex = 0,
        scrollOffset = 0;
      const liveSlots = new Map();
      const slotPrizes = [];
      const strip = document.getElementById("roulette-strip");

      function initRoulette() {
        strip.innerHTML = "";
        liveSlots.clear();
        scrollOffset = 0;
        slotPrizes.length = 0;
        winnerIndex = ROULETTE_TOTAL - Math.floor(Math.random() * 5) - 8;
        winnerPrize = PRIZES[Math.floor(Math.random() * PRIZES.length)];
        for (let i = 0; i < ROULETTE_TOTAL; i++)
          slotPrizes[i] =
            i === winnerIndex ? winnerPrize : PRIZES[i % PRIZES.length];
      }

      function updateVisibleSlots() {
        const vpW = document.getElementById("roulette-viewport").offsetWidth;
        const first = Math.floor((scrollOffset - 10 - ITEM_W) / ITEM_STEP);
        const last = Math.ceil((scrollOffset + vpW + 10) / ITEM_STEP);
        const vMin = Math.max(0, first),
          vMax = Math.min(ROULETTE_TOTAL - 1, last);
        for (const [idx, slot] of liveSlots) {
          if (idx < vMin || idx > vMax) {
            if (slot.anim)
              try {
                slot.anim.destroy();
              } catch (e) {}
            slot.el.remove();
            liveSlots.delete(idx);
          }
        }
        for (let i = vMin; i <= vMax; i++) {
          if (liveSlots.has(i)) {
            liveSlots.get(i).el.style.left =
              10 + i * ITEM_STEP - scrollOffset + "px";
          } else {
            const prize = slotPrizes[i];
            const item = document.createElement("div");
            item.className = "roulette-item";
            const sd = document.createElement("div");
            sd.className = "roulette-sticker";
            let anim = null;
            const data = tgsCache[prize.tgs];
            if (data) {
              try {
                anim = lottie.loadAnimation({
                  container: sd,
                  renderer: "svg",
                  loop: true,
                  autoplay: true,
                  animationData: JSON.parse(JSON.stringify(data)),
                });
              } catch (e) {
                sd.innerHTML = `<div class="roulette-emoji">${prize.emoji || "üéÅ"}</div>`;
              }
            } else {
              sd.innerHTML = `<div class="roulette-emoji">${prize.emoji || "üéÅ"}</div>`;
            }
            item.appendChild(sd);
            item.style.left = 10 + i * ITEM_STEP - scrollOffset + "px";
            strip.appendChild(item);
            liveSlots.set(i, { el: item, anim });
          }
        }
      }

      function spinRoulette() {
        const vpW = document.getElementById("roulette-viewport").offsetWidth;
        const target =
          10 +
          winnerIndex * ITEM_STEP +
          ITEM_W / 2 -
          vpW / 2 +
          (Math.random() - 0.5) * 15;
        const obj = { val: 0 };
        gsap.to(obj, {
          val: target,
          duration: 12,
          ease: "power4.out",
          onUpdate: () => {
            scrollOffset = obj.val;
            updateVisibleSlots();
          },
          onComplete: onRouletteStop,
        });
        updateVisibleSlots();
      }

      function onRouletteStop() {
        const slot = liveSlots.get(winnerIndex);
        if (slot) {
          gsap.to(slot.el, {
            borderColor: "#FFD700",
            boxShadow: "0 0 25px rgba(255,215,0,0.5)",
            duration: 0.4,
          });
          gsap.to(slot.el, {
            scale: 1.08,
            duration: 0.3,
            yoyo: true,
            repeat: 2,
            ease: "power2.inOut",
          });
        }
        document.getElementById("roulette-title").textContent =
          "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!";
        confetti({ particleCount: 120, spread: 100, origin: { y: 0.5 } });
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        apiCall("check-subscription", {
          action: "save_roll",
          prize_key: winnerPrize.key || winnerPrize.tgs,
          prize_name: winnerPrize.name,
        }).catch(() => {});
        setTimeout(showPrizeModal, 1200);
      }

      // ==============================================================
      //  MODALS
      // ==============================================================

      // --- Prize Modal ---
      function showPrizeModal() {
        destroyRouletteLotties();
        const overlay = document.getElementById("modal-prize");
        document.getElementById("modal-prize-name").textContent =
          winnerPrize.name;
        playLottieIn(
          document.getElementById("modal-prize-sticker"),
          winnerPrize.tgs,
          winnerPrize.emoji,
        );
        overlay.classList.remove("hidden");
        overlay.style.opacity = "0";
        gsap.to(overlay, { opacity: 1, duration: 0.3 });
        gsap.from(overlay.querySelector(".modal-box"), {
          scale: 0.5,
          y: 40,
          opacity: 0,
          duration: 0.5,
          ease: "back.out(1.7)",
          delay: 0.1,
        });
        confetti({ particleCount: 100, spread: 80, origin: { y: 0.5 } });
      }

      document.getElementById("btn-claim").addEventListener("click", () => {
        confetti({ particleCount: 100, spread: 100, origin: { y: 0.5 } });
        gsap.to("#modal-prize .modal-box", {
          scale: 0,
          opacity: 0,
          duration: 0.3,
          ease: "back.in(2)",
          onComplete: () => {
            document.getElementById("modal-prize").classList.add("hidden");
            showSubscribeModal();
          },
        });
      });

      // --- Subscribe Modal ---
      function showSubscribeModal() {
        destroyAllLotties();
        const overlay = document.getElementById("modal-subscribe");
        document.getElementById("sub-prize-name").textContent = winnerPrize
          ? winnerPrize.name
          : USER_STATE?.prize_name || "–ü—Ä–∏–∑";

        const tgsUrl = winnerPrize
          ? winnerPrize.tgs
          : PRIZES.find((p) => p.key === USER_STATE?.prize_key)?.tgs;
        const emoji = winnerPrize
          ? winnerPrize.emoji
          : PRIZES.find((p) => p.key === USER_STATE?.prize_key)?.emoji;
        if (tgsUrl)
          playLottieIn(document.getElementById("sub-sticker"), tgsUrl, emoji);

        // –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤
        const list = document.getElementById("channel-list");
        list.innerHTML = "";
        CHANNELS.forEach((ch) => {
          const li = document.createElement("li");
          li.className = "channel-item";
          li.innerHTML = `
            <div class="channel-avatar">
                ${ch.avatar ? `<img src="${ch.avatar}" alt="">` : "üì¢"}
            </div>
            <div class="channel-info">
                <div class="channel-name">${ch.name}</div>
            </div>
            <a href="${ch.link}" target="_blank" class="channel-sub-btn" 
               onclick="event.stopPropagation();">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</a>
        `;
          list.appendChild(li);
        });

        overlay.classList.remove("hidden");
        overlay.style.opacity = "0";
        gsap.to(overlay, { opacity: 1, duration: 0.3 });
        gsap.from(overlay.querySelector(".modal-box"), {
          scale: 0.5,
          y: 40,
          opacity: 0,
          duration: 0.5,
          ease: "back.out(1.7)",
          delay: 0.1,
        });
      }

      document
        .getElementById("btn-check-sub")
        .addEventListener("click", async () => {
          const btn = document.getElementById("btn-check-sub");
          btn.disabled = true;
          btn.querySelector("span").textContent = "–ü—Ä–æ–≤–µ—Ä—è–µ–º...";

          try {
            const res = await apiCall("check-subscription", {
              action: "check",
            });
            if (res.all_subscribed) {
              // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ "‚úì"
              document.querySelectorAll(".channel-sub-btn").forEach((b) => {
                b.textContent = "‚úì";
                b.classList.add("done");
              });
              showToast("–í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã!", "success");
              await sleep(1000);
              gsap.to("#modal-subscribe .modal-box", {
                scale: 0,
                opacity: 0,
                duration: 0.3,
                onComplete: () => {
                  document
                    .getElementById("modal-subscribe")
                    .classList.add("hidden");
                  showFinalModal();
                },
              });
            } else {
              // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ
              const items = document.querySelectorAll(".channel-item");
              CHANNELS.forEach((ch, i) => {
                const btn2 = items[i]?.querySelector(".channel-sub-btn");
                if (btn2) {
                  if (res.results[String(ch.id)]) {
                    btn2.textContent = "‚úì";
                    btn2.classList.add("done");
                  } else {
                    btn2.textContent = "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è";
                    btn2.classList.remove("done");
                  }
                }
              });
              showToast("–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã!", "error");
              try {
                Telegram.WebApp.HapticFeedback.notificationOccurred("error");
              } catch (e) {}
            }
          } catch (e) {
            showToast("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ", "error");
          }

          btn.disabled = false;
          btn.querySelector("span").textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É";
        });

      // --- Final Modal ---
      function showFinalModal() {
        destroyAllLotties();
        const overlay = document.getElementById("modal-final");
        const pName = winnerPrize
          ? winnerPrize.name
          : USER_STATE?.prize_name || "–ü—Ä–∏–∑";
        document.getElementById("final-prize-name").textContent = pName;

        const tgsUrl = winnerPrize
          ? winnerPrize.tgs
          : PRIZES.find((p) => p.key === USER_STATE?.prize_key)?.tgs;
        const emoji = winnerPrize
          ? winnerPrize.emoji
          : PRIZES.find((p) => p.key === USER_STATE?.prize_key)?.emoji;
        if (tgsUrl)
          playLottieIn(document.getElementById("final-sticker"), tgsUrl, emoji);

        overlay.classList.remove("hidden");
        overlay.style.opacity = "0";
        gsap.to(overlay, { opacity: 1, duration: 0.3 });
        gsap.from(overlay.querySelector(".modal-box"), {
          scale: 0.5,
          y: 40,
          opacity: 0,
          duration: 0.5,
          ease: "back.out(1.7)",
          delay: 0.1,
        });
        confetti({ particleCount: 200, spread: 160, origin: { y: 0.5 } });
      }

      function destroyRouletteLotties() {
        for (const [idx, slot] of liveSlots) {
          if (slot.anim)
            try {
              slot.anim.destroy();
            } catch (e) {}
          slot.anim = null;
        }
      }

      // ==============================================================
      //  INIT + STATE ROUTING
      // ==============================================================
      const ps = new Particles(document.getElementById("vfx-canvas"));
      ps.ambient();
      ps.tick();

      const raysBox = document.getElementById("rays-container");
      for (let i = 0; i < 12; i++) {
        const r = document.createElement("div");
        r.className = "ray";
        r.style.setProperty("--i", i);
        raysBox.appendChild(r);
      }

      async function init() {
        // Telegram
        try {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
          Telegram.WebApp.setHeaderColor("#fefefe");
          Telegram.WebApp.setBackgroundColor("#fefefe");
        } catch (e) {}

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
        try {
          const res = await apiCall("get-user");
          if (res.ok) {
            USER_STATE = res.user;
            CHANNELS = res.channels || [];
            PRIZES = res.prizes || PRIZES;
          }
        } catch (e) {
          console.warn("API unavailable, local mode");
          // –§–æ–ª–ª–±—ç–∫ ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑—ã
          PRIZES = [
            {
              key: "prize1",
              tgs: "assets/prize1.tgs",
              name: "100 Stars",
              emoji: "‚≠ê",
            },
            {
              key: "prize2",
              tgs: "assets/prize2.tgs",
              name: "–ü–æ–¥–∞—Ä–æ–∫",
              emoji: "üéÅ",
            },
            {
              key: "prize3",
              tgs: "assets/prize3.tgs",
              name: "Mini Oscar",
              emoji: "ü™ô",
            },
            {
              key: "prize4",
              tgs: "assets/prize4.tgs",
              name: "–ë—Ä–∏–ª–ª–∏–∞–Ω—Ç",
              emoji: "üíé",
            },
            {
              key: "prize5",
              tgs: "assets/prize5.tgs",
              name: "–ö–æ—Ä–æ–Ω–∞",
              emoji: "üëë",
            },
          ];
        }

        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ TGS
        const urls = [MAIN_STICKER_TGS, ...PRIZES.map((p) => p.tgs)];
        await Promise.all(urls.map((u) => loadTGS(u)));

        // –†–æ—É—Ç–∏–Ω–≥ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é
        if (USER_STATE?.state === "claimed") {
          document.getElementById("main-scene").classList.add("hidden");
          ps.stop();
          showFinalModal();
          return;
        }

        if (USER_STATE?.state === "rolled") {
          document.getElementById("main-scene").classList.add("hidden");
          ps.stop();
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º winnerPrize
          winnerPrize =
            PRIZES.find((p) => p.key === USER_STATE.prize_key) || PRIZES[0];
          showSubscribeModal();
          return;
        }

        // state === 'new' ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä—É–ª–µ—Ç–∫—É
        playLottieIn(
          document.getElementById("star-container"),
          MAIN_STICKER_TGS,
          MAIN_STICKER_EMOJI,
        );

        gsap
          .timeline()
          .from("#star-area", {
            scale: 0,
            rotation: 720,
            duration: 1.2,
            ease: "elastic.out(1,0.3)",
          })
          .from(
            ".ray",
            { height: 0, opacity: 0, duration: 0.5, stagger: 0.04 },
            "-=0.6",
          )
          .from("#glow", { scale: 0, opacity: 0, duration: 0.6 }, "-=0.7")
          .from(
            "#tap-text",
            { y: 25, opacity: 0, duration: 0.4, ease: "back.out(1.7)" },
            "-=0.2",
          )
          .from("#tap-counter", { y: 15, opacity: 0, duration: 0.3 }, "-=0.1");
      }

      init();

      // ==============================================================
      //  TAP
      // ==============================================================
      let tapCount = 0,
        isFinished = false;

      document
        .getElementById("star-wrapper")
        .addEventListener("pointerdown", (e) => {
          e.preventDefault();
          if (isFinished) return;
          tapCount++;
          const progress = tapCount / MAX_TAPS,
            sc = 1 + tapCount * 0.07;
          try {
            Telegram.WebApp.HapticFeedback.impactOccurred("medium");
          } catch (e) {}
          gsap.to("#star-container", {
            scale: sc + 0.15,
            duration: 0.08,
            onComplete: () =>
              gsap.to("#star-container", {
                scale: sc,
                duration: 0.25,
                ease: "elastic.out(1,0.3)",
              }),
          });
          gsap.to("#glow", {
            scale: 1 + progress * 0.9,
            opacity: 0.5 + progress * 0.5,
            duration: 0.15,
          });
          gsap.to(".ray", {
            height: 130 + progress * 90,
            opacity: 0.2 + progress * 0.7,
            duration: 0.15,
          });
          document.getElementById("progress-fill").style.width =
            `${progress * 100}%`;
          document.getElementById("counter-text").textContent =
            `${tapCount} / ${MAX_TAPS}`;
          const ft = document.createElement("div");
          ft.className = "tap-effect";
          ft.textContent = ["+1", "‚≠ê", "‚ú®", "üí´"][~~(Math.random() * 4)];
          ft.style.left = e.clientX + (Math.random() - 0.5) * 30 + "px";
          ft.style.top = e.clientY - 15 + "px";
          document.body.appendChild(ft);
          setTimeout(() => ft.remove(), 700);
          ps.burst(e.clientX, e.clientY);
          if (tapCount < MAX_TAPS) addShake(3 + tapCount * 0.7);
          const hue = 45 + progress * 25;
          document.body.style.background = `radial-gradient(ellipse at 50% 40%,hsl(${hue},80%,98%),hsl(${hue},30%,96%),hsl(${hue},20%,94%))`;
          if (tapCount >= MAX_TAPS) {
            isFinished = true;
            startFinale();
          }
        });

      // ==============================================================
      //  FINALE
      // ==============================================================
      async function startFinale() {
        freezeShake(28, 3000);
        gsap.to("#star-container", {
          scale: 2.2,
          filter: "brightness(2.5) drop-shadow(0 0 50px rgba(255,215,0,1))",
          duration: 2.5,
          ease: "power1.in",
        });
        gsap.to("#glow", { scale: 3, opacity: 1, duration: 2.5 });
        gsap.to(".ray", { height: 350, opacity: 1, duration: 2.5 });
        const burstLoop = setInterval(() => {
          const r = document
            .getElementById("star-container")
            .getBoundingClientRect();
          ps.burst(r.left + r.width / 2, r.top + r.height / 2, 5);
        }, 300);
        await sleep(3000);
        clearInterval(burstLoop);
        const r = document
          .getElementById("star-container")
          .getBoundingClientRect();
        ps.explode(r.left + r.width / 2, r.top + r.height / 2, 50);
        confetti({ particleCount: 50, spread: 50, origin: { x: 0.5, y: 0.4 } });
        destroyAllLotties();
        gsap.to("#flash", { opacity: 1, duration: 1, ease: "power2.in" });
        await sleep(1000);
        document.getElementById("main-scene").classList.add("hidden");
        shakeAmt = 0;
        shakeFrozen = false;
        ps.stop();
        initRoulette();
        document.getElementById("roulette-scene").classList.remove("hidden");
        spinRoulette();
        await sleep(400);
        gsap.to("#flash", { opacity: 0, duration: 1.2, ease: "power2.out" });
      }

      function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
      }
    </script>
  </body>
</html>
