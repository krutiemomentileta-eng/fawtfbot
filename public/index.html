<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>‚≠ê Tap & Win!</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background: #fff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }
      .hidden {
        display: none !important;
      }

      /* LOADING */
      #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .loading-spinner {
        width: 36px;
        height: 36px;
        border: 3px solid #eee;
        border-top: 3px solid #ffd700;
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .loading-text {
        color: #bbb;
        font-size: 13px;
        margin-top: 14px;
      }

      /* FLASH */
      #flash {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 999;
        pointer-events: none;
        opacity: 0;
      }

      /* MAIN */
      #main-scene {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2;
      }
      #star-area {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 260px;
        height: 260px;
      }

      /* RAYS ‚Äî –º–∏–Ω–∏–º—É–º, 6 –≤–º–µ—Å—Ç–æ 12 */
      .ray {
        position: absolute;
        top: 48%;
        left: 50%;
        width: 3px;
        height: 130px;
        transform-origin: bottom center;
        transform: translate(-50%, -100%) rotate(calc(var(--i) * 60deg));
        background: linear-gradient(
          to top,
          rgba(255, 215, 0, 0.4),
          rgba(255, 215, 0, 0)
        );
        border-radius: 2px;
        animation: ray-pulse 2.5s ease-in-out infinite;
        animation-delay: calc(var(--i) * 0.2s);
      }
      @keyframes ray-pulse {
        0%,
        100% {
          opacity: 0.15;
          transform: translate(-50%, -100%) rotate(calc(var(--i) * 60deg))
            scaleY(0.8);
        }
        50% {
          opacity: 0.5;
          transform: translate(-50%, -100%) rotate(calc(var(--i) * 60deg))
            scaleY(1.2);
        }
      }

      /* GLOW ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π, –±–µ–∑ blur */
      #glow {
        position: absolute;
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          rgba(255, 215, 0, 0.2) 0%,
          transparent 70%
        );
        animation: glow-breathe 3s ease-in-out infinite;
        pointer-events: none;
      }
      @keyframes glow-breathe {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.8;
        }
      }

      #star-wrapper {
        position: relative;
        cursor: pointer;
        z-index: 10;
        width: 140px;
        height: 140px;
      }
      #star-container {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 90px;
      }
      #pulse-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 150px;
        height: 150px;
        border: 2px solid rgba(255, 215, 0, 0.25);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: pulse-expand 2.5s ease-out infinite;
        pointer-events: none;
      }
      @keyframes pulse-expand {
        0% {
          transform: translate(-50%, -50%) scale(0.8);
          opacity: 0.8;
        }
        100% {
          transform: translate(-50%, -50%) scale(2);
          opacity: 0;
        }
      }

      #tap-text {
        margin-top: 20px;
        font-size: 26px;
        font-weight: 800;
        color: #333;
        letter-spacing: 2px;
      }
      .bounce-letter {
        display: inline-block;
        animation: letter-bounce 2s ease-in-out infinite;
        animation-delay: calc(var(--d) * 0.1s);
      }
      @keyframes letter-bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        20% {
          transform: translateY(-5px);
        }
      }

      #tap-counter {
        margin-top: 16px;
        text-align: center;
      }
      #progress-bar {
        width: 180px;
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
        margin: 0 auto 6px;
      }
      #progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #ffd700, #ffa500);
        border-radius: 3px;
      }
      #counter-text {
        font-size: 13px;
        color: #aaa;
        font-weight: 600;
      }

      .tap-effect {
        position: fixed;
        font-size: 20px;
        font-weight: 900;
        color: #ffd700;
        pointer-events: none;
        z-index: 100;
        animation: tap-fly 0.6s ease-out forwards;
      }
      @keyframes tap-fly {
        0% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-60px) scale(1.3);
        }
      }

      /* ROULETTE */
      #roulette-scene {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 60;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #fff;
      }
      #roulette-title {
        font-size: 22px;
        font-weight: 700;
        color: #333;
        margin-bottom: 30px;
      }
      #roulette-wrapper {
        position: relative;
        width: 92%;
        max-width: 450px;
      }
      #roulette-viewport {
        width: 100%;
        height: 120px;
        overflow: hidden;
        border-radius: 16px;
        background: #fafafa;
        border: 1px solid #eee;
        position: relative;
      }
      #roulette-strip {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      .roulette-item {
        position: absolute;
        top: 10px;
        width: 96px;
        height: 96px;
        border: 2.5px solid #d0d0d0;
        border-radius: 14px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .roulette-sticker {
        width: 72px;
        height: 72px;
      }
      .roulette-emoji {
        font-size: 42px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 72px;
        height: 72px;
      }
      #roulette-pointer-top {
        position: absolute;
        top: -14px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 11px solid transparent;
        border-right: 11px solid transparent;
        border-top: 14px solid #ffd700;
        z-index: 10;
      }
      #roulette-pointer-bottom {
        position: absolute;
        bottom: -14px;
        left: 50%;
        transform: translateX(-50%);
        border-left: 11px solid transparent;
        border-right: 11px solid transparent;
        border-bottom: 14px solid #ffd700;
        z-index: 10;
      }
      #roulette-line {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 50%;
        width: 2px;
        background: rgba(255, 215, 0, 0.5);
        transform: translateX(-50%);
        z-index: 10;
        pointer-events: none;
      }

      /* MODALS */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      .modal-box {
        background: white;
        border-radius: 24px;
        padding: 30px 24px;
        text-align: center;
        max-width: 340px;
        width: 90%;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-box h2 {
        font-size: 20px;
        color: #888;
        margin-bottom: 14px;
        font-weight: 600;
        letter-spacing: 1px;
      }
      .modal-sticker {
        width: 120px;
        height: 120px;
        margin: 0 auto 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 65px;
      }
      .modal-prize-name {
        font-size: 20px;
        font-weight: 800;
        color: #333;
        margin-bottom: 20px;
      }
      .btn-primary {
        position: relative;
        width: 100%;
        padding: 15px;
        font-size: 16px;
        font-weight: 700;
        color: white;
        background: linear-gradient(135deg, #ffd700, #ffa500);
        border: none;
        border-radius: 14px;
        cursor: pointer;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(255, 165, 0, 0.4);
      }
      .btn-primary:active {
        transform: scale(0.95);
      }
      .btn-primary:disabled {
        opacity: 0.6;
        pointer-events: none;
      }
      .btn-shine {
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shine-move 2.5s ease-in-out infinite;
      }
      @keyframes shine-move {
        0% {
          left: -100%;
        }
        50%,
        100% {
          left: 100%;
        }
      }

      .subscribe-desc {
        font-size: 14px;
        color: #666;
        margin-bottom: 18px;
        line-height: 1.5;
      }
      .channel-list {
        list-style: none;
        margin-bottom: 20px;
      }
      .channel-item {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
      }
      .channel-item:last-child {
        border-bottom: none;
      }
      .channel-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: #e0e0e0;
        margin-right: 12px;
        flex-shrink: 0;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #999;
      }
      .channel-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
      }
      .channel-info {
        flex: 1;
        text-align: left;
        min-width: 0;
      }
      .channel-name {
        font-size: 14px;
        font-weight: 600;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .channel-sub-btn {
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 600;
        color: #fff;
        background: #3390ec;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        flex-shrink: 0;
        margin-left: 10px;
      }
      .channel-sub-btn.done {
        background: #4caf50;
        pointer-events: none;
      }

      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: #ff4757;
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        z-index: 9999;
        transition: transform 0.3s ease;
        pointer-events: none;
      }
      .toast.show {
        transform: translateX(-50%) translateY(0);
      }
      .toast.success {
        background: #4caf50;
      }

      .final-icon {
        font-size: 50px;
        margin-bottom: 15px;
      }
      .final-title {
        font-size: 18px;
        font-weight: 700;
        color: #333;
        margin-bottom: 10px;
      }
      .final-text {
        font-size: 14px;
        color: #888;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <div id="loading-screen">
      <div class="loading-spinner"></div>
      <p class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
    <div id="flash"></div>
    <div id="toast" class="toast"></div>

    <!-- TAP -->
    <div id="main-scene" class="hidden">
      <div id="star-area">
        <div id="rays-container"></div>
        <div id="glow"></div>
        <div id="star-wrapper">
          <div id="star-container"></div>
          <div id="pulse-ring"></div>
        </div>
      </div>
      <div id="tap-text">
        <span class="bounce-letter" style="--d: 0">–ñ</span
        ><!--
        --><span class="bounce-letter" style="--d: 1">–º</span
        ><!--
        --><span class="bounce-letter" style="--d: 2">–∏</span
        ><!--
        --><span class="bounce-letter" style="--d: 3">&nbsp;</span
        ><!--
        --><span class="bounce-letter" style="--d: 4">–∂</span
        ><!--
        --><span class="bounce-letter" style="--d: 5">–º</span
        ><!--
        --><span class="bounce-letter" style="--d: 6">–∏</span
        ><!--
        --><span class="bounce-letter" style="--d: 7">!</span>
      </div>
      <div id="tap-counter">
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <span id="counter-text">0 / 10</span>
      </div>
    </div>

    <!-- ROULETTE -->
    <div id="roulette-scene" class="hidden">
      <div id="roulette-title">üé∞ –ö—Ä—É—Ç–∏–º —Ä—É–ª–µ—Ç–∫—É...</div>
      <div id="roulette-wrapper">
        <div id="roulette-pointer-top"></div>
        <div id="roulette-pointer-bottom"></div>
        <div id="roulette-line"></div>
        <div id="roulette-viewport">
          <div id="roulette-strip"></div>
        </div>
      </div>
    </div>

    <!-- MODALS -->
    <div id="modal-prize" class="modal-overlay hidden">
      <div class="modal-box">
        <h2>–í–ê–ú –í–´–ü–ê–õ:</h2>
        <div id="modal-prize-sticker" class="modal-sticker"></div>
        <p id="modal-prize-name" class="modal-prize-name"></p>
        <button id="btn-claim" class="btn-primary">
          <span>–ó–ê–ë–†–ê–¢–¨</span><span class="btn-shine"></span>
        </button>
      </div>
    </div>

    <div id="modal-subscribe" class="modal-overlay hidden">
      <div class="modal-box">
        <h2>üéÅ –ü–æ–ª—É—á–∏—Ç–µ –ø—Ä–∏–∑!</h2>
        <div id="sub-sticker" class="modal-sticker"></div>
        <p id="sub-prize-name" class="modal-prize-name"></p>
        <p class="subscribe-desc">
          –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–∑, –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞&nbsp;–Ω–∞—à–∏—Ö —Å–ø–æ–Ω—Å–æ—Ä–æ–≤:
        </p>
        <ul id="channel-list" class="channel-list"></ul>
        <button id="btn-check-sub" class="btn-primary">
          <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</span><span class="btn-shine"></span>
        </button>
      </div>
    </div>

    <div id="modal-final" class="modal-overlay hidden">
      <div class="modal-box">
        <div class="final-icon">‚úÖ</div>
        <div id="final-sticker" class="modal-sticker"></div>
        <p id="final-prize-name" class="modal-prize-name"></p>
        <h3 class="final-title">–ó–ê–Ø–í–ö–ê –ù–ê –í–´–í–û–î –ü–†–ò–ó–ê –û–¢–ü–†–ê–í–õ–ï–ù–ê!</h3>
        <p class="final-text">
          –ü—Ä–∏–∑ –±—É–¥–µ—Ç –≤—ã–¥–∞–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.<br />–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ! üéâ
        </p>
      </div>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ü–û–°–õ–ï –≤—Å–µ–≥–æ DOM -->
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"
    ></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"
    ></script>
    <script
      defer
      src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"
    ></script>

    <script>
      window.addEventListener("load", () => {
        const check = setInterval(() => {
          if (
            typeof gsap !== "undefined" &&
            typeof confetti !== "undefined" &&
            typeof lottie !== "undefined" &&
            typeof pako !== "undefined"
          ) {
            clearInterval(check);
            startApp();
          }
        }, 30);
      });

      function startApp() {
        const API_BASE = "/api";
        const MAIN_TGS = "assets/gift.tgs";
        const MAIN_EMOJI = "üéÅ";
        const MAX_TAPS = 10;
        const ROULETTE_TOTAL = 60;
        const ITEM_W = 96,
          ITEM_GAP = 10,
          ITEM_STEP = 106;

        let PRIZES = [],
          CHANNELS = [],
          USER_STATE = null;

        // ‚ïê‚ïê‚ïê TGS ‚Äî –ø—Ä–µ–¥–ø–∞—Ä—Å–µ–Ω–Ω—ã–π –∫–µ—à ‚ïê‚ïê‚ïê
        const tgsRaw = {}; // url ‚Üí JSON object (–æ—Ä–∏–≥–∏–Ω–∞–ª)
        const tgsClones = {}; // url ‚Üí JSON string (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)

        async function loadTGS(url) {
          if (tgsRaw[url] !== undefined) return tgsRaw[url];
          try {
            const r = await fetch(url);
            if (!r.ok) throw new Error(r.status);
            const buf = await r.arrayBuffer();
            const json = JSON.parse(
              pako.inflate(new Uint8Array(buf), { to: "string" }),
            );
            tgsRaw[url] = json;
            tgsClones[url] = JSON.stringify(json); // stringify –æ–¥–∏–Ω —Ä–∞–∑
            return json;
          } catch (e) {
            tgsRaw[url] = null;
            return null;
          }
        }

        function cloneTGS(url) {
          // –ë—ã—Å—Ç—Ä–µ–µ —á–µ–º JSON.parse(JSON.stringify(obj)) –∫–∞–∂–¥—ã–π —Ä–∞–∑
          const str = tgsClones[url];
          return str ? JSON.parse(str) : null;
        }

        // ‚ïê‚ïê‚ïê Lottie ‚Äî –º–∞–∫—Å–∏–º—É–º 1 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞ –º–æ–±–∏–ª–∫–µ ‚ïê‚ïê‚ïê
        let activeLotties = [];

        function playLottieIn(container, url, emoji) {
          container.innerHTML = "";
          const data = cloneTGS(url);
          if (data) {
            try {
              const anim = lottie.loadAnimation({
                container,
                renderer: "svg",
                loop: true,
                autoplay: true,
                animationData: data,
              });
              activeLotties.push(anim);
              return anim;
            } catch (e) {}
          }
          container.textContent = emoji || "üéÅ";
          return null;
        }

        function killAllLotties() {
          for (const a of activeLotties) {
            try {
              a.destroy();
            } catch (e) {}
          }
          activeLotties = [];
        }

        // ‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê
        function getInitData() {
          try {
            return Telegram.WebApp.initData;
          } catch (e) {
            return "";
          }
        }
        async function api(ep, body = {}) {
          const r = await fetch(`${API_BASE}/${ep}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ initData: getInitData(), ...body }),
          });
          return r.json();
        }

        function showToast(text, type = "error", ms = 3000) {
          const t = document.getElementById("toast");
          t.textContent = text;
          t.className = "toast " + type;
          requestAnimationFrame(() => t.classList.add("show"));
          setTimeout(() => t.classList.remove("show"), ms);
        }

        // ‚ïê‚ïê‚ïê SHAKE ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è ‚ïê‚ïê‚ïê
        let shakeAmt = 0,
          shakeFrozen = false,
          shakeRaf = null;
        const mainScene = document.getElementById("main-scene");

        function addShake(a) {
          shakeAmt = Math.min(shakeAmt + a, 40);
          if (!shakeRaf) tickShake();
        }
        function freezeShake(a, ms) {
          shakeAmt = a;
          shakeFrozen = true;
          if (!shakeRaf) tickShake();
          setTimeout(() => (shakeFrozen = false), ms);
        }
        function tickShake() {
          if (shakeAmt < 0.5 && !shakeFrozen) {
            mainScene.style.transform = "";
            shakeRaf = null;
            return;
          }
          mainScene.style.transform = `translate(${((Math.random() - 0.5) * shakeAmt * 2) | 0}px,${((Math.random() - 0.5) * shakeAmt * 2) | 0}px)`;
          if (!shakeFrozen) shakeAmt *= 0.85;
          shakeRaf = requestAnimationFrame(tickShake);
        }

        // ‚ïê‚ïê‚ïê ROULETTE ‚Äî –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è ‚ïê‚ïê‚ïê
        let winnerPrize = null,
          winnerIndex = 0,
          scrollOffset = 0;
        const liveSlots = new Map();
        const slotPrizes = [];
        const strip = document.getElementById("roulette-strip");

        // –ü—É–ª DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ ‚Äî –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–º–µ—Å—Ç–æ create/destroy
        const itemPool = [];

        function getPooledItem() {
          if (itemPool.length > 0) return itemPool.pop();
          const item = document.createElement("div");
          item.className = "roulette-item";
          const sd = document.createElement("div");
          sd.className = "roulette-sticker";
          item.appendChild(sd);
          return item;
        }

        function returnToPool(item, anim) {
          if (anim)
            try {
              anim.destroy();
            } catch (e) {}
          item.firstChild.innerHTML = "";
          item.style.borderColor = "#d0d0d0";
          item.style.boxShadow = "none";
          item.style.transform = "";
          strip.removeChild(item);
          itemPool.push(item);
        }

        function initRoulette() {
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å—ë –≤ –ø—É–ª
          for (const [idx, slot] of liveSlots) returnToPool(slot.el, slot.anim);
          liveSlots.clear();
          scrollOffset = 0;
          slotPrizes.length = 0;
          winnerIndex = ROULETTE_TOTAL - Math.floor(Math.random() * 5) - 8;

          const forcedKey = USER_STATE?.forced_prize;
          if (forcedKey) {
            winnerPrize =
              PRIZES.find((p) => p.key === forcedKey) ||
              PRIZES[Math.floor(Math.random() * PRIZES.length)];
          } else {
            winnerPrize = PRIZES[Math.floor(Math.random() * PRIZES.length)];
          }

          for (let i = 0; i < ROULETTE_TOTAL; i++) {
            slotPrizes[i] =
              i === winnerIndex ? winnerPrize : PRIZES[i % PRIZES.length];
          }
        }

        // –¢—Ä–æ—Ç—Ç–ª–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º—ã—Ö —Å–ª–æ—Ç–æ–≤
        let lastUpdateScroll = -999;

        function updateVisible() {
          // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–µ —á–∞—â–µ —á–µ–º –∫–∞–∂–¥—ã–µ 50px —Å–∫—Ä–æ–ª–ª–∞
          if (Math.abs(scrollOffset - lastUpdateScroll) < 50) {
            // –ù–æ –ø–æ–∑–∏—Ü–∏–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º
            for (const [idx, slot] of liveSlots) {
              slot.el.style.left = 10 + idx * ITEM_STEP - scrollOffset + "px";
            }
            return;
          }
          lastUpdateScroll = scrollOffset;

          const vpW = document.getElementById("roulette-viewport").offsetWidth;
          const first = Math.floor((scrollOffset - 10 - ITEM_W) / ITEM_STEP);
          const last = Math.ceil((scrollOffset + vpW + 10) / ITEM_STEP);
          const vMin = Math.max(0, first),
            vMax = Math.min(ROULETTE_TOTAL - 1, last);

          // –£–±–∏—Ä–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–µ
          for (const [idx, slot] of liveSlots) {
            if (idx < vMin || idx > vMax) {
              returnToPool(slot.el, slot.anim);
              liveSlots.delete(idx);
            }
          }

          // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–µ
          for (let i = vMin; i <= vMax; i++) {
            if (liveSlots.has(i)) {
              liveSlots.get(i).el.style.left =
                10 + i * ITEM_STEP - scrollOffset + "px";
            } else {
              const prize = slotPrizes[i];
              const item = getPooledItem();
              const sd = item.firstChild;

              // Emoji ‚Äî —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Ä—É–ª–µ—Ç–∫–∏
              sd.innerHTML = `<div class="roulette-emoji">${prize.emoji || "üéÅ"}</div>`;

              let anim = null;
              // Lottie —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∏–¥–∏–º—ã—Ö –∏ –±–ª–∏–∑–∫–∏—Ö –∫ —Ü–µ–Ω—Ç—Ä—É
              const distFromCenter = Math.abs(
                i * ITEM_STEP - scrollOffset - vpW / 2,
              );
              if (distFromCenter < vpW * 0.8 && tgsRaw[prize.tgs]) {
                sd.innerHTML = "";
                try {
                  anim = lottie.loadAnimation({
                    container: sd,
                    renderer: "svg",
                    loop: true,
                    autoplay: true,
                    animationData: cloneTGS(prize.tgs),
                  });
                } catch (e) {
                  sd.innerHTML = `<div class="roulette-emoji">${prize.emoji || "üéÅ"}</div>`;
                }
              }

              item.style.left = 10 + i * ITEM_STEP - scrollOffset + "px";
              strip.appendChild(item);
              liveSlots.set(i, { el: item, anim });
            }
          }
        }

        function spinRoulette() {
          const vpW = document.getElementById("roulette-viewport").offsetWidth;
          const target =
            10 +
            winnerIndex * ITEM_STEP +
            ITEM_W / 2 -
            vpW / 2 +
            (Math.random() - 0.5) * 15;
          const obj = { val: 0 };

          gsap.to(obj, {
            val: target,
            duration: 12,
            ease: "power4.out",
            onUpdate() {
              scrollOffset = obj.val;
              updateVisible();
            },
            onComplete: onStop,
          });
          updateVisible();
        }

        function onStop() {
          // –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
          lastUpdateScroll = -999;
          updateVisible();

          const slot = liveSlots.get(winnerIndex);
          if (slot) {
            slot.el.style.borderColor = "#FFD700";
            slot.el.style.boxShadow = "0 0 20px rgba(255,215,0,0.4)";
            gsap.to(slot.el, {
              scale: 1.05,
              duration: 0.2,
              yoyo: true,
              repeat: 2,
            });
          }
          document.getElementById("roulette-title").textContent =
            "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!";
          confetti({ particleCount: 60, spread: 70, origin: { y: 0.5 } });
          api("check-subscription", {
            action: "save_roll",
            prize_key: winnerPrize.key || winnerPrize.tgs,
            prize_name: winnerPrize.name,
          }).catch(() => {});
          setTimeout(showPrizeModal, 1000);
        }

        // ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê
        function showPrizeModal() {
          // –£–±–∏–≤–∞–µ–º –í–°–ï lottie —Ä—É–ª–µ—Ç–∫–∏
          for (const [, slot] of liveSlots) {
            if (slot.anim) {
              try {
                slot.anim.destroy();
              } catch (e) {}
              slot.anim = null;
            }
          }
          killAllLotties();

          const ov = document.getElementById("modal-prize");
          document.getElementById("modal-prize-name").textContent =
            winnerPrize.name;
          playLottieIn(
            document.getElementById("modal-prize-sticker"),
            winnerPrize.tgs,
            winnerPrize.emoji,
          );
          ov.classList.remove("hidden");
          gsap.from(ov.querySelector(".modal-box"), {
            scale: 0.5,
            y: 30,
            opacity: 0,
            duration: 0.4,
            ease: "back.out(1.7)",
          });
          confetti({ particleCount: 50, spread: 50, origin: { y: 0.5 } });
        }

        document.getElementById("btn-claim").addEventListener("click", () => {
          const ov = document.getElementById("modal-prize");
          gsap.to(ov.querySelector(".modal-box"), {
            scale: 0,
            opacity: 0,
            duration: 0.25,
            onComplete() {
              ov.classList.add("hidden");
              showSubModal();
            },
          });
        });

        function showSubModal() {
          killAllLotties();
          const ov = document.getElementById("modal-subscribe");
          const pName = winnerPrize
            ? winnerPrize.name
            : USER_STATE?.prize_name || "–ü—Ä–∏–∑";
          document.getElementById("sub-prize-name").textContent = pName;

          const tUrl = winnerPrize
            ? winnerPrize.tgs
            : PRIZES.find((p) => p.key === USER_STATE?.prize_key)?.tgs;
          const em = winnerPrize
            ? winnerPrize.emoji
            : PRIZES.find((p) => p.key === USER_STATE?.prize_key)?.emoji;
          if (tUrl)
            playLottieIn(document.getElementById("sub-sticker"), tUrl, em);

          const list = document.getElementById("channel-list");
          list.innerHTML = "";
          CHANNELS.forEach((ch) => {
            const li = document.createElement("li");
            li.className = "channel-item";
            li.innerHTML = `
            <div class="channel-avatar">${ch.avatar ? `<img src="${ch.avatar}" loading="lazy">` : "üì¢"}</div>
            <div class="channel-info"><div class="channel-name">${ch.name}</div></div>
            <button class="channel-sub-btn" data-link="${ch.link}">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>`;
            list.appendChild(li);
          });

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
          list.querySelectorAll(".channel-sub-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation();
              const link = btn.getAttribute("data-link");
              try {
                if (link && link.includes("t.me/"))
                  Telegram.WebApp.openTelegramLink(link);
                else Telegram.WebApp.openLink(link);
              } catch (err) {
                window.open(link, "_blank");
              }
            });
          });

          ov.classList.remove("hidden");
          gsap.from(ov.querySelector(".modal-box"), {
            scale: 0.5,
            y: 30,
            opacity: 0,
            duration: 0.4,
            ease: "back.out(1.7)",
          });
        }

        document
          .getElementById("btn-check-sub")
          .addEventListener("click", async () => {
            const btn = document.getElementById("btn-check-sub");
            btn.disabled = true;
            btn.querySelector("span").textContent = "–ü—Ä–æ–≤–µ—Ä—è–µ–º...";

            try {
              const res = await api("check-subscription", { action: "check" });
              if (res.all_subscribed) {
                document.querySelectorAll(".channel-sub-btn").forEach((b) => {
                  b.textContent = "‚úì";
                  b.classList.add("done");
                });
                showToast("–ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã!", "success");
                await sleep(800);
                const ov = document.getElementById("modal-subscribe");
                gsap.to(ov.querySelector(".modal-box"), {
                  scale: 0,
                  opacity: 0,
                  duration: 0.25,
                  onComplete() {
                    ov.classList.add("hidden");
                    showFinalModal();
                  },
                });
              } else {
                const items = document.querySelectorAll(".channel-item");
                CHANNELS.forEach((ch, i) => {
                  const b = items[i]?.querySelector(".channel-sub-btn");
                  if (b) {
                    if (res.results[String(ch.id)]) {
                      b.textContent = "‚úì";
                      b.classList.add("done");
                    } else {
                      b.textContent = "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è";
                      b.classList.remove("done");
                    }
                  }
                });
                showToast("–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã!");
                try {
                  Telegram.WebApp.HapticFeedback.notificationOccurred("error");
                } catch (e) {}
              }
            } catch (e) {
              showToast("–û—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ");
            }

            btn.disabled = false;
            btn.querySelector("span").textContent = "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É";
          });

        function showFinalModal() {
          killAllLotties();
          const ov = document.getElementById("modal-final");
          const pName = winnerPrize
            ? winnerPrize.name
            : USER_STATE?.prize_name || "–ü—Ä–∏–∑";
          document.getElementById("final-prize-name").textContent = pName;
          const tUrl = winnerPrize
            ? winnerPrize.tgs
            : PRIZES.find((p) => p.key === USER_STATE?.prize_key)?.tgs;
          const em = winnerPrize
            ? winnerPrize.emoji
            : PRIZES.find((p) => p.key === USER_STATE?.prize_key)?.emoji;
          if (tUrl)
            playLottieIn(document.getElementById("final-sticker"), tUrl, em);
          ov.classList.remove("hidden");
          gsap.from(ov.querySelector(".modal-box"), {
            scale: 0.5,
            y: 30,
            opacity: 0,
            duration: 0.4,
            ease: "back.out(1.7)",
          });
          confetti({ particleCount: 60, spread: 80, origin: { y: 0.5 } });
        }

        // ‚ïê‚ïê‚ïê RAYS ‚Äî 6 –≤–º–µ—Å—Ç–æ 12 ‚ïê‚ïê‚ïê
        const raysBox = document.getElementById("rays-container");
        for (let i = 0; i < 6; i++) {
          const r = document.createElement("div");
          r.className = "ray";
          r.style.setProperty("--i", i);
          raysBox.appendChild(r);
        }

        // ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
        async function init() {
          try {
            Telegram.WebApp.expand();
            Telegram.WebApp.setHeaderColor("#ffffff");
            Telegram.WebApp.setBackgroundColor("#ffffff");
          } catch (e) {}

          try {
            const res = await api("get-user");
            if (res.ok) {
              USER_STATE = res.user;
              CHANNELS = res.channels || [];
              PRIZES = res.prizes || [];
            }
          } catch (e) {
            PRIZES = [
              {
                key: "prize1",
                tgs: "assets/prize1.tgs",
                name: "Scared Cat",
                emoji: "",
              },
              {
                key: "prize2",
                tgs: "assets/prize2.tgs",
                name: "Perfume Bottle",
                emoji: "",
              },
              {
                key: "prize3",
                tgs: "assets/prize3.tgs",
                name: "Mini Oscar",
                emoji: "",
              },
              {
                key: "prize4",
                tgs: "assets/prize4.tgs",
                name: "Kissed Frog",
                emoji: "",
              },
              {
                key: "prize5",
                tgs: "assets/prize5.tgs",
                name: "Swiss Watch",
                emoji: "",
              },
              {
                key: "prize6",
                tgs: "assets/prize6.tgs",
                name: "Signet Ring",
                emoji: "",
              },
              {
                key: "prize7",
                tgs: "assets/prize7.tgs",
                name: "Mad Pumpkin",
                emoji: "",
              },
              {
                key: "prize8",
                tgs: "assets/prize8.tgs",
                name: "Voodoo Doll",
                emoji: "",
              },
              {
                key: "prize9",
                tgs: "assets/prize9.tgs",
                name: "Magic Potion",
                emoji: "",
              },
              {
                key: "prize10",
                tgs: "assets/prize10.tgs",
                name: "Genie Lamp",
                emoji: "",
              },
              {
                key: "prize11",
                tgs: "assets/prize11.tgs",
                name: "Precious Peach",
                emoji: "",
              },
              {
                key: "prize12",
                tgs: "assets/prize12.tgs",
                name: "Astral Shard",
                emoji: "",
              },
              {
                key: "prize13",
                tgs: "assets/prize13.tgs",
                name: "Ion Gem",
                emoji: "",
              },
            ];
          }

          // –ì—Ä—É–∑–∏–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ TGS
          if (!USER_STATE || USER_STATE.state === "new") {
            await loadTGS(MAIN_TGS);
            // –ü—Ä–∏–∑—ã –≥—Ä—É–∑–∏–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            await Promise.all(PRIZES.map((p) => loadTGS(p.tgs)));
          } else {
            const prizeUrl = PRIZES.find(
              (p) => p.key === USER_STATE.prize_key,
            )?.tgs;
            if (prizeUrl) await loadTGS(prizeUrl);
          }

          // –£–±–∏—Ä–∞–µ–º –ª–æ–∞–¥–µ—Ä
          const ls = document.getElementById("loading-screen");
          ls.style.opacity = "0";
          ls.style.transition = "opacity 0.3s";
          setTimeout(() => ls.classList.add("hidden"), 300);

          try {
            Telegram.WebApp.ready();
          } catch (e) {}

          // –†–æ—É—Ç–∏–Ω–≥
          if (USER_STATE?.state === "claimed") {
            showFinalModal();
            return;
          }
          if (USER_STATE?.state === "rolled") {
            winnerPrize =
              PRIZES.find((p) => p.key === USER_STATE.prize_key) || PRIZES[0];
            showSubModal();
            return;
          }

          // new
          document.getElementById("main-scene").classList.remove("hidden");
          playLottieIn(
            document.getElementById("star-container"),
            MAIN_TGS,
            MAIN_EMOJI,
          );

          // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ö–æ–¥–∞ ‚Äî –æ–¥–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è
          gsap.from("#star-area", {
            scale: 0,
            duration: 0.8,
            ease: "back.out(1.5)",
          });
          gsap.from("#tap-text", {
            y: 20,
            opacity: 0,
            duration: 0.4,
            delay: 0.5,
          });
          gsap.from("#tap-counter", {
            y: 15,
            opacity: 0,
            duration: 0.3,
            delay: 0.6,
          });
        }

        init();

        // ‚ïê‚ïê‚ïê TAP ‚ïê‚ïê‚ïê
        let taps = 0,
          finished = false;

        document
          .getElementById("star-wrapper")
          .addEventListener("pointerdown", (e) => {
            e.preventDefault();
            if (finished) return;
            taps++;
            const p = taps / MAX_TAPS;

            try {
              Telegram.WebApp.HapticFeedback.impactOccurred("medium");
            } catch (e) {}

            // –ü—Ä–æ—Å—Ç–æ–π scale ‚Äî –±–µ–∑ elastic (–¥–µ—à–µ–≤–ª–µ)
            const sc = 1 + taps * 0.06;
            const el = document.getElementById("star-container");
            el.style.transform = `scale(${sc + 0.1})`;
            setTimeout(() => (el.style.transform = `scale(${sc})`), 80);

            // –ü—Ä–æ–≥—Ä–µ—Å—Å
            document.getElementById("progress-fill").style.width =
              `${p * 100}%`;
            document.getElementById("counter-text").textContent =
              `${taps} / ${MAX_TAPS}`;

            // –õ–µ—Ç–∞—é—â–∏–π —Ç–µ–∫—Å—Ç ‚Äî –º–∞–∫—Å–∏–º—É–º 3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
            if (document.querySelectorAll(".tap-effect").length < 3) {
              const ft = document.createElement("div");
              ft.className = "tap-effect";
              ft.textContent = ["+1", "‚≠ê", "‚ú®"][~~(Math.random() * 3)];
              ft.style.left = e.clientX + (Math.random() - 0.5) * 20 + "px";
              ft.style.top = e.clientY - 10 + "px";
              document.body.appendChild(ft);
              setTimeout(() => ft.remove(), 600);
            }

            if (taps < MAX_TAPS) addShake(2 + taps * 0.5);

            if (taps >= MAX_TAPS) {
              finished = true;
              startFinale();
            }
          });

        // ‚ïê‚ïê‚ïê FINALE ‚ïê‚ïê‚ïê
        async function startFinale() {
          freezeShake(25, 2500);

          const el = document.getElementById("star-container");
          el.style.transition = "transform 2s, filter 2s";
          el.style.transform = "scale(2)";
          el.style.filter =
            "brightness(2) drop-shadow(0 0 30px rgba(255,215,0,0.8))";

          await sleep(2500);

          confetti({
            particleCount: 30,
            spread: 40,
            origin: { x: 0.5, y: 0.4 },
          });
          killAllLotties();
          el.style.transition = "";

          // Fade to white
          const flash = document.getElementById("flash");
          flash.style.transition = "opacity 0.8s";
          flash.style.opacity = "1";
          await sleep(800);

          document.getElementById("main-scene").classList.add("hidden");
          shakeAmt = 0;
          shakeFrozen = false;

          initRoulette();
          document.getElementById("roulette-scene").classList.remove("hidden");
          spinRoulette();

          await sleep(300);
          flash.style.transition = "opacity 1s";
          flash.style.opacity = "0";
        }

        function sleep(ms) {
          return new Promise((r) => setTimeout(r, ms));
        }
      } // startApp
    </script>
  </body>
</html>
